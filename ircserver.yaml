---
- hosts: all
  sudo: true
  gather_facts: no

  pre_tasks:
    - debug: var=ansible_hostname
    - name: install python if it is not there already
      raw: apt-get update && apt-get -y install python
    - name: Gathering facts
      setup:
    - name: copy some directories to /usr/src/
      copy: src={{item}} dest=/usr/src/OverTheWire-ircserver/ owner=irc group=irc mode=0400 directory_mode=0500
      with_items:
          - inspircd-config
          - inspircd-secrets
          - inspircd-code
          - OverTheWire-boobiesbot
    - name: set hostname in case vagrant fucks up
      shell: "hostnamectl set-hostname {{ ansible_hostname }}"
      when: from_vagrant is defined and from_vagrant

  roles:
    - generic
    - shorewall
    - shorewall6
    - dockerhost
    - role: dockerimagebuilder
      images:
        - name: boobiesbot
          path: /usr/src/OverTheWire-ircserver/OverTheWire-boobiesbot
        - name: inspircd
          path: /usr/src/OverTheWire-ircserver/inspircd-code

  tasks:
    - name: install some packages
      apt: "name={{ item }} state=present"
      with_items:
        - irssi

    - name: create inspircd service file
      template: src=inspircd-code/inspircd.service.j2 dest=/etc/systemd/system/inspircd.service
      register: inspircdservice

    - name: reload systemd if needed
      command: systemctl daemon-reload
      when: inspircdservice.changed
    - name: start inspircd
      service: name=inspircd state=started

    - name: configure shorewall
      lineinfile: "dest={{ item.filename }} line=\"{{ item.line }}\" state=present create=yes"
      with_items:
          - { filename: "/etc/shorewall/interfaces", line: "vms docker0" }
          - { filename: "/etc/shorewall/masq", line: "eth0 172.17.0.0/16" }
          - { filename: "/etc/shorewall/rules", line: "ACCEPT:info ext fw tcp 6666,6667,6697" }
          - { filename: "/etc/shorewall/rules", line: "ACCEPT:info vms ext all" }
          - { filename: "/etc/shorewall/rules", line: "ACCEPT:info vms fw all" }
          - { filename: "/etc/shorewall/rules", line: "ACCEPT:info fw vms all" }
          - { filename: "/etc/shorewall/zones", line: "vms ipv4" }
      notify:
        - restart shorewall
      tags:
        - firewall

    - name: configure shorewall to allow incoming irc-server connections
      lineinfile: "dest=/etc/shorewall/rules line=\"ACCEPT:info ext:{{item}} fw tcp 7029\" state=present create=yes"
      with_items:
          - 46.101.57.19      # barbie
          - 104.131.10.16   # roxanne
          - 72.20.33.91       # irc1.us
          - 174.37.216.199    # irc2.us
          # - 81.169.186.131    # irc3.de
          - 5.9.146.202       # irc4.de
      notify:
        - restart shorewall
      tags:
        - firewall


    - name: install some packages
      apt: "name={{ item }} state=present"
      with_items:
        - mongodb-server
        - supervisor
      when: runboobiesbot is defined and runboobiesbot

    - name: configure mongodb
      lineinfile: dest=/etc/mongodb.conf regexp="^bind_ip" line="bind_ip = 0.0.0.0" state=present create=yes
      register: mongodbconf
      when: runboobiesbot is defined and runboobiesbot

    - name: restarting mongodb if needed
      service: name=mongodb state=restarted
      when: mongodbconf.changed
      when: runboobiesbot is defined and runboobiesbot

    - name: start boobiesbot at boot
      copy: src={{item.src}} dest={{item.dest}} mode={{item.mode}}
      when: runboobiesbot is defined and runboobiesbot
      with_items:
          - src: OverTheWire-boobiesbot/launch-boobiesbot-container
            dest: /usr/local/bin/launch-boobiesbot-container
            mode: "0755"
          - src: OverTheWire-boobiesbot/supervisor.conf
            dest: /etc/supervisor/conf.d/boobiesbot.conf
            mode: "0644"
      register: supervisorconf

    - name: reload supervisor if needed
      service: name=supervisor state=restarted
      when: runboobiesbot is defined and runboobiesbot and supervisorconf.changed
   
